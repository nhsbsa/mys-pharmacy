
{% extends "prototype-kit-template.njk" %}

{% block head %}
  <link href="/css/main.css" rel="stylesheet">
{% endblock %}

{% block pageTitle %}{{ serviceName }}{% endblock %}

{% block header %}

  {{ header({
    service: {
      text: serviceName,
      href: '/'
    },
    account: {
      items: [
        {
          text: 'Logged in as Joe Bloggs',
          action: '/',
          icon: false
        },
        {
          text: 'Log out',
          href: '/'
        }
      ]
    }
  }) }}
  
{% endblock %}



{% block footer %}

  {{ footer({
    meta: {
      items: [
        {
          href: '#',
          text: 'Home'
        },
        {
          href: '#',
          text: 'Privacy'
        },
        {
          href: '#',
          text: 'Email the MYS support team'
        },
        {
          href: '#',
          text: 'Call us 0300 330 1368'
        },
        { href: 'https://online1.snapsurveys.com/interview/816b552f-4a8a-4786-bcef-0c2fd4d1dc35',
          text: 'Give us your feedback about your experience'
        }
      ]
    }
  }) }}


  <!-- SESSION TIMEOUT -->
  <dialog id="js-modal-dialog" data-url-redirect="https://mys-pharmacy.herokuapp.com/session-timeout"
   data-session-timeout="300" data-session-timeout-warning="300"
   data-session-timeout-timer-text="You have been inactive for 10 minutes and will be signed out automatically in 5 minutes if no action is taken. <br><br> Are you still there?"  data-session-timeout-timer-extra-text=""
   class="modal-dialog dialog" role="dialog" aria-live="polite" aria-labelledby="dialog-title" aria-describedby="at-timer">
   <div class="modal-dialog__inner">
      <h1 id="dialog-title" class="heading-large">
         You will be signed out soon
      </h1>      
      <div class="modal-dialog__inner__text">
         <div id="timer" class="timer" aria-hidden="true" aria-relevant="additions"></div>
         <div id="at-timer" class="at-timer nhsuk-u-visually-hidden" role="status"></div>
      </div>
      <div class="modal-dialog__inner__block">
         <button class="nhsuk-button js-dialog-close">Yes, Iâ€™m here</button>
         <a href="/login" class="nhsuk-button js-dialog-logout nhsuk-button--secondary">Sign out</a>
      </div>
   </div>
</dialog>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const dialog = document.getElementById("js-modal-dialog");
  const closeBtn = dialog.querySelector(".js-dialog-close");
  const logoutBtn = dialog.querySelector(".js-dialog-logout");

  // These values come from your data attributes
  const warningTime = Number(dialog.dataset.sessionTimeoutWarning) * 600000; // ms
  const redirectTime = Number(dialog.dataset.sessionTimeout) * 300000; // ms
  const redirectUrl = dialog.dataset.urlRedirect;

  let warningTimer, logoutTimer, activityEvents = ['mousemove', 'keydown', 'click', 'scroll'];

  function resetTimers() {
    // Clear old timers
    clearTimeout(warningTimer);
    clearTimeout(logoutTimer);

    // Hide dialog if visible
    if (dialog.open) dialog.close();

    // Start new timers
    warningTimer = setTimeout(showWarning, warningTime);
    logoutTimer = setTimeout(logoutUser, redirectTime);
  }

  function showWarning() {
    if (!dialog.open) dialog.showModal();
  }

  function logoutUser() {
    window.location.href = redirectUrl;
  }

  // User says "I'm here"
  closeBtn.addEventListener('click', () => {
    dialog.close();
    resetTimers();
  });

  // Logout button
  logoutBtn.addEventListener('click', () => {
    logoutUser();
  });

  // Reset timers on any user activity
  activityEvents.forEach(evt => {
    window.addEventListener(evt, resetTimers, { passive: true });
  });

  // Initialize timers at start
  resetTimers();
});
</script>

{% endblock %}

